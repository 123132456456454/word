# import unittest
# import requests
# import json

# class APITestCase(unittest.TestCase):
#     BASE_URL = "http://localhost:5102"
    
#     def test_search_endpoint(self):
#         """测试/search接口基础功能"""
#         payload = {
#             "baseconfig": {"入板方向":"左进右出","滚轮直径":"32","轴距":"35","输送面":"860mm","工作速度":1.5,"孔径比":"20：1（通孔） 1:1 (盲孔)","最小孔径":"0.2mm(通孔)0.075mm（盲孔）",},
#             "config": [
#                         {"流程名称":"入板","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"膨松","反应时间":"125s","工作温度":"75±3℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"止水洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"除胶渣","反应时间":"249s","工作温度":"87±3℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"回收水洗+DI水洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗+预中和+水刀洗","反应时间":"21s","工作温度":"20~30℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"Water Elast","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"中和","反应时间":"47s","工作温度":"35~45℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"吸水铺","水洗级数":"3"},
#                         {"流程名称":"检查","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"除油","反应时间":"61s","工作温度":"58~62℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"调整","反应时间":"61s","工作温度":"58~62℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"整孔后","水洗级数":"3"},
#                         {"流程名称":"微蚀","反应时间":"79s","工作温度":"33~35℃","客户选配":"喷淋+浸泡","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"预浸","反应时间":"24s","工作温度":"25~30℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"活化","反应时间":"67s","工作温度":"40~50℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"活化后","水洗级数":"3"},
#                         {"流程名称":"还原","反应时间":"53s","工作温度":"30~40℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"沉铜","反应时间":"419s","工作温度":"28~46℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"吸水铺","水洗级数":"4"},
#                         {"流程名称":"干板组合","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"冷却","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"出板","反应时间":"","工作温度":"","客户选配":"","水洗级数":""}
#                         ]
#         }
#         response = requests.post(
#             f"{self.BASE_URL}/search",
#             json=payload,
#             headers={"Content-Type": "application/json"}
#         )
#         self.assertEqual(response.status_code, 200)
#         self.assertIn("response", response.json())
#         print(response.json())
        
#     # def test_excel_processing(self):
#     #     """测试Excel数据处理逻辑"""
#     #     # 需准备测试用Excel文件
#     #     test_data = ["DESOML", "左进右出", "40", "35", "860"]
#         # result = process_excel_data("test_data.xlsx", test_data)
#         # self.assertGreater(len(result), 0)

# if __name__ == "__main__":
#     unittest.main()



import unittest
import requests
import json
import time

# "baseconfig": {"入板方向":"左进右出","滚轮直径":"40","轴距":"35","输送面":"860","工作速度":3,"孔径比":"孔深孔径比8:1 [通孔][孔径≧0.2mm]"},
#             "config":[
#             {"流程名称": "入板2", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "显影", "反应时间": "50s", "工作温度": "30±2℃", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "新液洗", "反应时间": "11s", "工作温度": "30±2℃", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "冲污水+加压水洗", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": "4"},
#             {"流程名称": "硫酸镁洗+加压水洗", "反应时间": "8s", "工作温度": "", "客户选配": "", "水洗级数": "4"},
#             {"流程名称": "检查", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "真空蚀刻", "反应时间": "88s", "工作温度": "48~52℃", "客户选配": "喷淋+浸泡", "水洗级数": ""},
#             {"流程名称": "二流体+真空蚀刻", "反应时间": "30s", "工作温度": "50℃±2℃", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "止水洗+加压水洗", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "检查", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "退膜", "反应时间": "120s", "工作温度": "50~55℃", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "新液洗", "反应时间": "11s", "工作温度": "50℃", "客户选配": "", "水洗级数": "3"},
#             {"流程名称": "冲污水+加压水洗", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "酸洗+加压水洗", "反应时间": "8s", "工作温度": "", "客户选配": "", "水洗级数": "3"},
#             {"流程名称": "干板组合", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "冷却", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""},
#             {"流程名称": "出板", "反应时间": "", "工作温度": "", "客户选配": "", "水洗级数": ""}
#             ]



# "baseconfig": {"入板方向":"左进右出","滚轮直径":"32","轴距":"35","输送面":"860","工作速度":1.5,"孔径比":"20：1（通孔） 1:1 (盲孔)","最小孔径":"0.2mm(通孔)0.075mm（盲孔）",},
#             "config": [
#                         {"流程名称":"入板","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"膨松","反应时间":"125s","工作温度":"75±3℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"止水洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"除胶渣","反应时间":"249s","工作温度":"87±3℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"回收水洗+DI水洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗+预中和+水刀洗","反应时间":"21s","工作温度":"20~30℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"Water Blast","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"中和","反应时间":"47s","工作温度":"35~45℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"吸水铺","水洗级数":"3"},
#                         {"流程名称":"检查","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"除油","反应时间":"61s","工作温度":"58~62℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"调整","反应时间":"61s","工作温度":"58~62℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"整孔后","水洗级数":"3"},
#                         {"流程名称":"微蚀","反应时间":"79s","工作温度":"33~35℃","客户选配":"喷淋+浸泡","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"预浸","反应时间":"24s","工作温度":"25~30℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"活化","反应时间":"67s","工作温度":"40~50℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"活化后","水洗级数":"3"},
#                         {"流程名称":"还原","反应时间":"53s","工作温度":"30~40℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"沉铜","反应时间":"419s","工作温度":"28~46℃","客户选配":"","水洗级数":""},
#                         {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"吸水铺","水洗级数":"4"},
#                         {"流程名称":"干板组合","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"冷却","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
#                         {"流程名称":"出板","反应时间":"","工作温度":"","客户选配":"","水洗级数":""}
#                         ]


class APITestStreamingTestCase(unittest.TestCase):
    BASE_URL = "http://192.168.57.86:5102"
    
    def test_streaming_response(self):
        """测试流式JSON响应处理"""
        payload = {
            "baseconfig": {"入板方向":"左进右出","滚轮直径":"32","轴距":"35","输送面":"860","工作速度":1.5,"孔径比":"20：1（通孔） 1:1 (盲孔)","最小孔径":"0.2mm(通孔)0.075mm（盲孔）",},
            "config": [
                        {"流程名称":"入板","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"膨松","反应时间":"125s","工作温度":"75±3℃","客户选配":"","水洗级数":""},
                        {"流程名称":"止水洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"除胶渣","反应时间":"249s","工作温度":"87±3℃","客户选配":"","水洗级数":""},
                        {"流程名称":"回收水洗+DI水洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"水刀洗+预中和+水刀洗","反应时间":"21s","工作温度":"20~30℃","客户选配":"","水洗级数":""},
                        {"流程名称":"Water Blast","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"中和","反应时间":"47s","工作温度":"35~45℃","客户选配":"","水洗级数":""},
                        {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"吸水铺","水洗级数":"3"},
                        {"流程名称":"检查","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"除油","反应时间":"61s","工作温度":"58~62℃","客户选配":"","水洗级数":""},
                        {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"调整","反应时间":"61s","工作温度":"58~62℃","客户选配":"","水洗级数":""},
                        {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"整孔后","水洗级数":"3"},
                        {"流程名称":"微蚀","反应时间":"79s","工作温度":"33~35℃","客户选配":"喷淋+浸泡","水洗级数":""},
                        {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"预浸","反应时间":"24s","工作温度":"25~30℃","客户选配":"","水洗级数":""},
                        {"流程名称":"活化","反应时间":"67s","工作温度":"40~50℃","客户选配":"","水洗级数":""},
                        {"流程名称":"冲污水+水刀洗","反应时间":"","工作温度":"","客户选配":"活化后","水洗级数":"3"},
                        {"流程名称":"还原","反应时间":"53s","工作温度":"30~40℃","客户选配":"","水洗级数":""},
                        {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"沉铜","反应时间":"419s","工作温度":"28~46℃","客户选配":"","水洗级数":""},
                        {"流程名称":"水刀洗","反应时间":"","工作温度":"","客户选配":"吸水铺","水洗级数":"4"},
                        {"流程名称":"干板组合","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"冷却","反应时间":"","工作温度":"","客户选配":"","水洗级数":""},
                        {"流程名称":"出板","反应时间":"","工作温度":"","客户选配":"","水洗级数":""}
                        ]
        }
        
        # 发送流式请求
        with requests.post(
            f"{self.BASE_URL}/search",
            json=payload,
            headers={"Content-Type": "application/json"},
            stream= False
        ) as response:
            # 验证基础响应状态
            self.assertEqual(response.status_code, 200)
            self.assertEqual(response.headers.get('Content-Type'), 'application/json; charset=utf-8')
            
            # 流式处理逻辑
            chunks = []
            start_time = time.time()
            print(response)
            print(response.content.decode('unicode_escape'))
        
            # for chunk in response.iter_lines():
            #     # 过滤心跳/空行
            #     if chunk:
            #         decoded_chunk = chunk.decode('unicode_escape')
            #         # decoded_chunk = bytes(decoded_chunk, 'utf-8').decode('unicode_escape')
            #         chunks.append(decoded_chunk)
            #         print(decoded_chunk)

            # 性能验证
            duration = time.time() - start_time
            print(f"▶ 收到 {len(chunks)} 个数据块 | 耗时: {duration:.2f}s")
            
            # 完整性验证
            self.assertEqual(len(chunks), len(payload["config"]))
            
            print(chunks)
            

if __name__ == "__main__":
    unittest.main()